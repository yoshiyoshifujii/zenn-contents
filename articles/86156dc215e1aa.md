---
title: "Go で試す多態パターンとシリアライズの整理"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["go"]
published: true
---

[yoshiyoshifujii/go-sample](https://github.com/yoshiyoshifujii/go-sample/tree/main/sample_polymorphism) のサンプルをもとに、Go で多態を扱う 4 パターンとシリアライズの整理をまとめる。

## サンプル構成

- `notifier_1.go` 〜 `notifier_4.go`: 4 パターンの多態実装
- `serializer.go`: 共通の `notifierPayload`（type/address/number）に変換する層
- `broadcast.go`: `Notify(string) string` を持つスライスを一括送信するジェネリック関数
- `serializer_test.go`: 各パターンが JSON 往復できることを検証

## 4 つの多態パターン

- **V1: interface + 値レシーバ**  
  `[]Notifier1` を直接扱う最小構成。シリアライズ時は concrete 型を型スイッチで列挙。
- **V2: ラッパ構造体に channel interface を埋め込み**  
  呼び出し側は `Notify` だけを見る。差し替えやすいが二重抽象で少し冗長。シリアライズはラップした `ch` の concrete 型をアサート。
- **V3: タグ付き struct 分岐**  
  `notifierType` タグでメール/SMS を切り替える。外部の `"type"` と親和性が高いが、タグとフィールドの整合性は人力で維持する必要がある。
- **V4: 関数型の戦略注入**  
  構造体に `notify func(string) string` を閉じ込める。軽量に差し替えられるが、関数フィールドゆえ比較が難しく、シリアライズでは別途 `payload` を持たせる。

## Serializer の方針

- 薄い中間表現 `notifierPayload` を用意し、`toPayloads` / `fromPayloads` をジェネリクス化して変換ループを共通化。
- 各バージョンは「型固有の変換関数」だけ渡す。エラーハンドリングも共通化できる。
- V1/V2 は型スイッチ、V3 はタグ、V4 は構造体に保持した `payload` をそのまま使う。

```go
func toPayloads[T any](ns []T, convert func(T) (notifierPayload, error)) ([]notifierPayload, error) {
	out := make([]notifierPayload, 0, len(ns))
	for _, n := range ns {
		payload, err := convert(n)
		if err != nil {
			return nil, err
		}
		out = append(out, payload)
	}
	return out, nil
}
```

## Broadcast の共通化

`broadcast[T interface{ Notify(string) string }]` で `Notify` を持つ任意のスライスを一括処理し、各バージョン固有の `BroadcastV*` を廃止して重複を削減。

```go
func broadcast[T interface{ Notify(string) string }](ns []T, message string) []string {
	out := make([]string, 0, len(ns))
	for _, n := range ns {
		out = append(out, n.Notify(message))
	}
	return out
}
```

## JSON 往復のポイント

- インタフェースや非公開フィールドはそのままでは JSON に乗らない。型情報を失わず往復したい場合は、`type` を明示的に埋め込むか、公開フィールド＋タグで構造を整える必要がある。
- `notifierPayload` のような薄い中間表現を持つことで、ドメイン構造を崩さずに外部フォーマットへ対応できる。

## 選択の指針と動かし方

- ドメインの読みやすさを優先するなら **V1** を起点に
- 実装差し替えを強調したいなら **V2**
- 外部の `"type"` 文字列と揃えたいなら **V3**
- 軽量に戦略を差し替えたいなら **V4**（関数フィールドゆえ比較しにくい点に注意）。

