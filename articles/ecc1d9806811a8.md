---
title: "Rustã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚„ã£ã¦ã¿ãŸ"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rust", "CleanArchitecture"]
published: false
---
Rustã‚’å‹‰å¼·ã—ãŸãã¦è‰²ã€…ã¨ã‚°ã‚°ã£ã¦ãŸã‚‰ã€ä»¥ä¸‹ã®è¨˜äº‹ã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ‹èª­ã•ã›ã¦ã„ãŸã ãã€å‚è€ƒã«ã•ã›ã¦ã„ãŸã ããªãŒã‚‰æ¨¡å†™ã•ã›ã¦ã„ãŸã ã„ãŸã€‚

- https://blog.foresta.me/posts/rust-layered-architecture/
- https://blog.j5ik2o.me/entry/2021/12/08/000000

ã¨ã¦ã‚‚å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ï¼

GitHubã¯ã€ https://github.com/yoshiyoshifujii/rust-api-architecture-sample ã§ã™ã€‚

# first commit

Cargoã¯ã„ã„ãã£ã¦èã„ã¦ã¾ã—ãŸãŒã€ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚

ã²ã¨ã¾ãšã€ã©ã®dependenciesã§ä½•ãŒã§ãã‚‹ã®ã‹ã¨ã‹ã‚ˆãåˆ†ã‹ã£ã¦ã„ã¾ã›ã‚“ãŒã€å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã‚µã‚¤ãƒˆã®å†…å®¹ã‚’è¦‹ã¤ã¤ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

ã‚¨ãƒ‡ã‚£ã‚¿ã¯ã€IntelliJ IDEAã«Rustãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€Cargo.tomlã§ã€dependenciesã‚’ç·¨é›†ã—ã¦ã„ã‚‹ã¨ã€è£œå®ŒãŒåŠ¹ã„ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å¼•ã„ã¦ãã¦ãã‚Œã‚‹ã®ã§ã€ã™ã”ã„æ¥½ã«å…¥åŠ›ã§ãã¾ã—ãŸã€‚

ã™ã”ã„ãªãƒ¼

```toml:Cargo.toml
...

[dependencies]
actix-web = "3.3.3"
futures = "0.3.19"
serde = "1.0.133"
serde_derive = "1.0.133"
serde_json = "1.0.75"
dotenv = "0.15.0"
chrono = "0.4.19"
failure = "0.1.8"
ulid = "0.5.0"

[dependencies.diesel]
features = ["mysql", "chrono", "r2d2"]
version = "1.4.8"
```

# domains

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãªæ„Ÿã˜ã§ã„ããªã‚‰ã€ã¾ãšã¯ã€Domainã‚’æ›¸ãã‚ˆã­ã£ã¦ã“ã¨ã§ã€ãã“ã‹ã‚‰æ›¸ãå§‹ã‚ã¦ã¿ã¾ã—ãŸã€‚

`main.rs` ã« `mod domains;` ã£ã¦æ›¸ã„ã¦ã€IDEAã§è£œå®Œã™ã‚‹ã¨ã€ `domains/mod.rs` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ãã‚Œã‚‹ã®ã§ã€ `pub mod documents;` ã£ã¦æ›¸ã„ã¦ã€è£œå®Œã‚’åŠ¹ã‹ã›ã¦â€¦
ã£ã¦æ„Ÿã˜ã§ã€ç°¡å˜ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã‚’ä½œã£ã¦ã„ã‘ã‚‹ã®ãŒã€ã™ã”ã„æ¥½ã—ã„ã§ã™ã€‚

## DocumentId

Idã¯ã€ [Ulid](https://docs.rs/ulid/0.5.0/ulid/) ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

```rust:src/domains/documents.rs
use ulid::Ulid;

#[derive(Debug, Clone, Hash, PartialEq, Eq)]
pub struct DocumentId {
    pub value: String,
}

impl DocumentId {
    pub fn new() -> Self {
        let id = Ulid::new();
        Self {
            value: id.to_string(),
        }
    }
}
```

domainãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€ã§ãã‚‹ã ã‘ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ä¾å­˜ã‚’å°‘ãªãã—ãŸã„ã£ã¦ãªã£ãŸã¨ãã€Scalaã ã¨sbtã®multi projectã§ã“ã®ã‚ãŸã‚Šã‚’åˆ¶å¾¡ã—ãŸã‚Šã™ã‚‹ã‚“ã§ã™ãŒã€Rustã®å ´åˆã¯ã©ã†ã™ã‚‹ã®ã‹ãªâ€¦

ã‚ãƒ¼ https://doc.rust-jp.rs/book-ja/ch14-03-cargo-workspaces.html ã“ã®ã‚ãŸã‚Šã«ã‚ã‚Šãã†ã€‚

å³å¯†ã«ä¾å­˜ã®æ–¹å‘æ€§ã‚’å¼·åˆ¶ã•ã›ã‚‹ã®ã§ã‚ã‚Œã°â†‘ä¸Šè¨˜ã®ã‚ãŸã‚Šã‚‚è€ƒæ…®ã—ã¦ã„ãã¨è‰¯ã•ãã†ã ãªãƒ¼

## DocumentTitle

ç‰¹ã«æ“ä½œã‚’æŒãŸãªã„ã®ã§ã™ãŒã€titleã®äº‹å‰æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ãªã„ã¨ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã§ããªã„ã‚ˆã†ãªå‡¦ç†ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚

```rust:src/domains/documents.rs
#[derive(Debug, Clone)]
pub struct DocumentTitle {
    pub value: String,
}

impl DocumentTitle {
    pub fn new(value: String) -> Self {
        if value.is_empty() {
            panic!("Document title is not empty.")
        }
        if value.len() > 120 {
            panic!("Document title length is over 120.")
        }
        Self { value }
    }
}
```

Rustã¯ã€testã‚‚ã•ãã£ã¨æ›¸ã‘ã¦æ¥½ã—ã„ã§ã™ã­ã€‚

```rust
#[cfg(test)]
mod document_title_tests {
    use std::panic;

    use crate::domains::documents::DocumentTitle;

    #[test]
    fn success_document_title_new() {
        let value = String::from("new title");
        let actual = DocumentTitle::new(value.clone());
        assert_eq!(actual.value, value);
    }

    #[test]
    fn panic_document_title_input_to_empty_string() {
        let value = String::from("");
        let actual = panic::catch_unwind(|| DocumentTitle::new(value));
        assert!(actual.is_err());
    }

    #[test]
    fn panic_document_title_input_to_over_length() {
        let value = String::from("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890");
        let actual = panic::catch_unwind(|| DocumentTitle::new(value));
        assert!(actual.is_err());
    }
}
```

domainå±¤ã®ã‚ãŸã‚Šã¯ã€ã“ã‚“ãªæ„Ÿã˜ã§ã‚„ã£ã¦ã‘ã°ã„ã„ã‚“ã ãªãƒ¼ã£ã¦ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚

domainã«VOã‚’æ›¸ã„ã¦ã„ãã®ã¨ã‹ã€testã‚’ã•ãã•ãã£ã¨æ›¸ã„ã¦ã„ãã‚ãŸã‚Šã®æ›¸ãã£ã·ã‚ŠãŒæ°—æŒã¡ã„ã„ã®ã¯ã€ã¨ã¦ã‚‚è‰¯ã„ã§ã™ã­ãƒ¼

# usecases

æ¬¡ã¯ã€domainsã‚’ä½¿ã†ã‚ãŸã‚Šã®usecasesã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

`main.rs` ã« `mod usecases;` ã£ã¦æ›¸ã„ã¦ã€IDEAã§ã”ã«ã‚‡ã£ã¦â€¦ã£ã¦æ„Ÿã˜ã§ã€`src/usecases/documents.rs` ã‚’ä½œã‚Šã¾ã™ã€‚

ã“ã“ã‚‚ã•ãã•ãã£ã¨ã„ã‘ã¦æ°—æŒã¡ã„ã„ã§ã™ã€‚

[Clean Architecture](https://amzn.to/35iMpz6) ã®æ›¸ç±ã®ä¸­ã§ã€ãƒœãƒ–ãŠã˜ã•ã‚“ãŒã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚‚ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ã¤ã„ã¦å«ã¶ã¹ãã£ã¦ãŠã£ã—ã‚ƒã£ã¦ãŸã®ã§ã€å«ã¶ã‚ˆã†ãªæ„Ÿã˜ã§æ›¸ã„ã¦ã„ããŸã„ã¨ã“ã‚ã€‚

å«ã¶ã£ã¦ã„ã†ã‚ãŸã‚Šã¯ã€ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã§ãã¦ã„ãªã„ã‘ã©ã€ã“ã“ã§å«ã‚“ã§ã„ã‘ã°è‰¯ã„ã‚ˆã­ã£ã¦ã„ã†ã®ã¯ã€ãªã‚“ã¨ãªãè¦‹ãˆãŸâ€¦ã‹â€¦ãª?

```rust
#[derive(Debug, Clone)]
pub struct PostDocumentInput {
    title: DocumentTitle,
    body: DocumentBody,
}

impl PostDocumentInput {
    pub fn new(title: DocumentTitle, body: DocumentBody) -> Self {
        Self { title, body }
    }
}

#[derive(Debug, Clone)]
pub struct PostDocumentOutput {
    pub id: DocumentId,
}

impl PostDocumentOutput {
    pub fn new(id: DocumentId) -> Self {
        Self { id }
    }
}

pub fn post_document(
    repository: &mut impl DocumentRepository,
    input: &PostDocumentInput,
) -> Result<PostDocumentOutput, Error> {
    let document = Document::create(input.title.to_owned(), input.body.to_owned());
    let result = repository.insert(&document);
    result.map(|_| PostDocumentOutput::new(document.id))
}
```

I/Oç”¨ã®structã‚’ç”¨æ„ã—ã¦ã€ `post_document` ã£ã¦ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‚“ã ã‚ˆï¼ã£ã¦æ„Ÿã˜ã€‚

Inputã¯ä½•ã§ã€Outputã¯ãªã‚“ã ã‚ˆã£ã¦ã‚ãŸã‚Šã‹ã€‚

ä»Šå›ã¯ã€ `src/usecases/document.rs` ã®1ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ã„ã‚‹ã‘ã©ã€ã•ã‚‰ã« `mod` ã‚’åˆ‡ã£ã¦ã€ `src/usecases/documents/post_document.ts` ã£ã¦ã—ã¦ã„ã‘ã°ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ä¸€è¦§ã¯ã—ã‚„ã™ãã†ã€‚

# repositories

`src/repositories/documents.ts` ã‚’ä½œã£ãŸã€‚

ã“ã“ã¯ã€traitã‚’æ›¸ã„ã¦ãŠãã ã‘ã«ã—ã¦ã€implã¯ã€ `interface_adaptors` ã§MySQLç”¨ã¨ã‹ã€ `usecases` ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€OnMemoryç”¨ã¨ã‹ã‚’ impl ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚

```rust
pub trait DocumentRepository {
      fn insert(&mut self, document: &Document) -> Result<(), Error>;
}
```

## testç”¨ã«ã€OnMemoryç‰ˆã®Repository

```rust
pub struct DocumentRepositoryImplOnMemory {
    pool: HashMap<DocumentId, Vec<Document>>,
}

impl DocumentRepository for DocumentRepositoryImplOnMemory {
    fn insert(&mut self, document: &Document) -> Result<(), Error> {
        let _ = &self
            .pool
            .entry(document.id.clone())
            .or_insert_with(|| vec![])
            .push(document.clone());
        Ok(())
    }
}
```

## MySQLç‰ˆã®Repository

```rust
pub struct DocumentRepositoryImplOnMySQL {
    pub pool: Box<Pool<ConnectionManager<MysqlConnection>>>,
}

impl DocumentRepository for DocumentRepositoryImplOnMySQL {
    fn insert(&mut self, document: &Document) -> Result<(), Error> {
        use super::super::interface_adaptors::databases::schema::documents::dsl;

        let entity = DocumentEntity::from(document);
        let conn = self.pool.get().unwrap();
        diesel::insert_into(dsl::documents)
            .values(entity)
            .execute(&conn)?;

        Ok(())
    }
}
```

# ãã®ä»–

MySQLã¨ã®ã‚„ã‚Šã¨ã‚Šã¯ã€ORMã®ã€ https://diesel.rs/ ã‚’ä½¿ã£ãŸã‚Šã€HTTP Serverã®ã‚ãŸã‚Šã¯ã€ https://actix.rs/ ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

ãŒã€ã“ã®ã‚ãŸã‚Šã¯ã€ãã‚Œãã‚Œã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã©ã†ä½¿ã†ã‹ã£ã¦ã“ã¨ãªã®ã§ã€è©³ç´°ã®è©±ã«ãªã£ã¦ãã‚‹ãªãƒ¼ã£ã¦æ„Ÿã˜ã€‚

Clean Architectureã®è€ƒãˆã§ã€å€‹äººçš„ã«é‡è¦ã ãªãƒ¼ã¨è€ƒãˆã¦ã„ã‚‹ã®ã¯ã€æ–¹é‡ã®å®Ÿè£…ã«è©³ç´°ã‚’æŒã¡è¾¼ã¾ãªã„ã£ã¦ã‚ãŸã‚Šã ã¨æ€ã£ã¦ã„ã‚‹ã€‚

ä»Šå›ã€Rustã§ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®Ÿè£…ã—ã¦ã¿ã¦ã€æ–¹é‡ã‚’å…ˆã«è©°ã‚ã¦ã€è©³ç´°ã¯ã‚ã¨ã‹ã‚‰ä½œã‚Šè¾¼ã‚“ã§ã„ã‘ãã†ãªæ°—é…ã‚’æ„Ÿã˜ã‚Œã¦ã€ã¨ã¦ã‚‚è‰¯ã‹ã£ãŸã§ã™ã€‚
