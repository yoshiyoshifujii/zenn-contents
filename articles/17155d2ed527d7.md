---
title: "集約IDをどう設計するか（第1回）"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["集約","Identity"]
published: false
---

# 集約IDをどう設計するか（第1回）

## ― 集約IDの基礎とコンテキストの設定 ―

ID設計は、一見すると「一意な文字列を生成すればよい」程度に思われがちです。  
しかし実際には、 **どの境界で、何を同一とみなすか** という設計判断が伴うため、非常に奥が深い領域だなーと思ってます。

特に、ドメイン駆動設計（DDD）における **集約（Aggregate）のID** は、単なる「識別子」以上の意味を持ちます。

第1回では、集約IDとは何か、どんな前提で設計すべきかを整理します。

---

## 1. 集約IDとは何か

ここで言う集約IDとは「ひとつの集約インスタンス」を識別するための同一性キーのことです。

- Order は「集約の型（境界の定義）」
- OrderID は「特定のひとつの注文（Orderインスタンス）を指すキー」

この前提で話を進めます。

---

## 2. 集約ID設計は「コンテキストの定義」から始まる

IDは「一意になってほしいもの」ですが、そもそも **どの範囲で一意なのか** を決めないと、設計が迷走します。

### 一意性の“空間的スコープ”

例えば、一意であるべき範囲はどれでしょう？

- 世界で一意  
- 会社全体で一意  
- サービス（マイクロサービス）内で一意  
- 特定のテーブル内で一意  
- 特定のユーザー内で一意  

**どのスコープで一意性が必要かによって、採用すべきID方式が変わります。**

### 一意性の“時間的スコープ”

IDには時間軸もあります。

- 無期限で一意であればよい  
- 月次／年次ごとにリセットされてもよい  
- 集約のライフサイクル内で一意であればよい  

例：  
「年度ごとに1から採番される伝票番号」は、時間スコープを限定して一意性を保つ設計です。

---

## 3. 集約IDにナチュラルキーは使えるか？

多くのドメインには、「ビジネス上の自然な一意性」を持つ情報があります。

- `merchant_order_id`（加盟店内で一意な注文番号）  
- `member_id + order_seq`（会員ごとの連番）  
- `email`（ユーザー識別に使われがち）

これらは **ナチュラルキー** と呼ばれます。

ナチュラルキーは確かにビジネス上便利ですが、  
**集約IDとして採用するのは危険**なことが多いです。

理由：

- ビジネスルールや仕様変更の影響を直に受ける  
- 外部システムの都合で形式が変更される  
- 桁数や意味がドメインの進化により変化する  
- 再生成や再採番の余地があり「一貫して不変」とは限らない  

つまり、

> **ナチュラルキーは“ビジネスキー”として扱い、  
> 集約IDとは別フィールドに分離するのが良い。**

---

## 4. サロゲートキー（UUIDなど）を採用するメリット

ナチュラルキーに対して、  
UUID／ULID／Snowflake／AUTO_INCREMENT などのように、

> システム側で生成する「意味を持たないID」

を **サロゲートキー** と呼びます。

サロゲートキーを集約IDとして使うメリットは明確です：

- ビジネスルールの変更に強い  
- 外部システムとの連携変更に強い  
- 不変性を担保しやすい  
- 分散環境でも生成しやすい（特に UUID/ULID）  

特に Order や Payment のような長寿命で変化しやすいドメインでは、

> **集約IDはサロゲートキーが基本。  
> ナチュラルキーはビジネス的な参照キーとして別途持つ。**

という設計が結果的に最も安定します。

---

## 5. 「新規IDを生成すべきか」「既存IDを使うべきか」の判断

Order/Payment まわりでしばしば起きる議論です。

- 新しい注文を作ったら新しい OrderID ？  
- 決済をやり直したら、新しい PaymentID ？  
- リトライ時はどうすべき？  

これは、

> **それが集約の新しいライフサイクルかどうか**

で判断できます。

### 新しいライフサイクルなら、新しいID

例：

- 別の注文を作りたい  
- 別の支払い方法で決済をやり直す  
- 新しい購入処理に入った

### 同じライフサイクル上の「再試行」なら、既存IDを継続

例：

- 同じ支払いの再実行（idempotenceの対象）  
- API リクエストのリトライ  
- 外部に PaymentIntent のような固有IDがあり、それがライフサイクルを表す場合

ただし、この話の詳細は**第3回で深掘り**します。

---

## 6. まとめ（第1回の要点）

- 集約IDは、「集約インスタンスそのものの同一性キー」  
- 集約ID＝境界の名前ではない  
- 一意性には空間スコープと時間スコープがある  
- ナチュラルキーはビジネスキーであり、集約IDにしない方が良い  
- 集約IDはサロゲートキー（UUIDなど）が基本  
- 新規IDか既存IDかは「新しいライフサイクルかどうか」で判断する

第2回では、一意性・順序性の分離や、UUID/ULID/Snowflake の比較、  
そして「順序性がないIDの難しさ」に踏み込みます。

---

（つづく）
